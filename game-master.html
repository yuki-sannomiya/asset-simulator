<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>è³‡ç”£ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ - ãƒã‚¤ï¼†ãƒ­ãƒ¼æŠ•è³‡ã‚²ãƒ¼ãƒ ï¼ˆGMç”¨ï¼‰</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #fff; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    .total { font-weight: bold; font-size: 1.2em; }
    button { padding: 10px 20px; font-size: 1em; margin-right: 10px; }
    .log { background: #f8f8f8; padding: 10px; border: 1px solid #ccc; margin-top: 20px; max-height: 150px; overflow-y: auto; }
    .section { margin-bottom: 30px; }
    .current-returns { background: #e6f3ff; padding: 15px; margin: 20px 0; border-radius: 5px; }
    .player-status { background: #f0f8e6; padding: 15px; margin: 20px 0; border-radius: 5px; }
    .status-connected { color: green; }
    .status-disconnected { color: red; }
  </style>
</head>
<body>
  <h1>è³‡ç”£ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆãƒã‚¤ï¼†ãƒ­ãƒ¼æŠ•è³‡ã‚²ãƒ¼ãƒ ï¼‰- GMç”¨</h1>

  <div class="section">
    <label>ãƒ«ãƒ¼ãƒ ID: <input type="text" id="roomId" value="testroom"></label>
    <button onclick="initializeRoom()">ãƒ«ãƒ¼ãƒ åˆæœŸåŒ–</button>
    <span id="connectionStatus" class="status-disconnected">æœªæ¥ç¶š</span>
    
    <div id="shareSection" style="display: none; margin-top: 15px; padding: 15px; background: #f0f8ff; border-radius: 5px;">
      <h3>ğŸ® ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ‹›å¾…</h3>
      <div style="margin-bottom: 10px;">
        <strong>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”¨ãƒªãƒ³ã‚¯ï¼š</strong>
        <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
          <input type="text" id="playerLink" readonly style="flex: 1; padding: 5px;">
          <button onclick="copyLink()" style="padding: 5px 10px;">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
          <button onclick="generateQR()" style="padding: 5px 10px;">ğŸ“± QRã‚³ãƒ¼ãƒ‰</button>
        </div>
      </div>
      <div id="qrSection" style="display: none; text-align: center; margin-top: 15px;">
        <div id="qrcode"></div>
        <p style="margin: 10px 0; font-size: 0.9em; color: #666;">
          ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã®ã‚«ãƒ¡ãƒ©ã§QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„
        </p>
      </div>
    </div>
  </div>

  <div class="current-returns">
    <h3>ç¾åœ¨ã®åˆ©å›ã‚Šè¨­å®š</h3>
    <table>
      <thead>
        <tr><th>è³‡ç”£ã‚¿ã‚¤ãƒ—</th><th>ç¾åœ¨åˆ©å›ã‚Šï¼ˆ%ï¼‰</th></tr>
      </thead>
      <tbody>
        <tr><td>å®šæœŸé é‡‘</td><td class="base-return">2.0</td></tr>
        <tr><td>å›½å‚µãƒ•ã‚¡ãƒ³ãƒ‰</td><td class="base-return">3.0</td></tr>
        <tr><td>æ ªå¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹</td><td class="base-return">6.0</td></tr>
        <tr><td>ãƒã‚¤ãƒ†ã‚¯æ ª</td><td class="base-return">10.0</td></tr>
        <tr><td>ä»®æƒ³é€šè²¨</td><td class="base-return">30.0</td></tr>
        <tr><td>ãƒ™ãƒ³ãƒãƒ£ãƒ¼æŠ•è³‡</td><td class="base-return">0.0</td></tr>
      </tbody>
    </table>
  </div>

  <div class="player-status">
    <h3>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‚åŠ çŠ¶æ³</h3>
    <ul id="playerList">
      <li>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‚åŠ ã‚’å¾…ã£ã¦ã„ã¾ã™...</li>
    </ul>
  </div>

  <div class="section" id="gmSection">
    <h2>ã‚²ãƒ¼ãƒ é€²è¡Œæ“ä½œ</h2>
    <button id="gmButton" onclick="startRound()">ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹ï¼ˆè¨ˆç®—ã®ã¿ï¼‰</button>
    <p id="eventStatus">ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿã‚’å¾…ã£ã¦ã„ã¾ã™...</p>

    <div class="section">
      <h2>ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠã—ã¦åæ˜ </h2>
      <select id="eventSelect">
        <option value="">â–¼ ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠ â–¼</option>
        <option value="0,1,é‡‘åˆ©ä¸Šæ˜‡ã§å®šæœŸé é‡‘ +1%">é‡‘åˆ©ä¸Šæ˜‡ã§å®šæœŸé é‡‘ +1%</option>
        <option value="0,-1,ãƒ‡ãƒ•ãƒ¬æ‡¸å¿µã§å®šæœŸé é‡‘ -1%">ãƒ‡ãƒ•ãƒ¬æ‡¸å¿µã§å®šæœŸé é‡‘ -1%</option>
        <option value="1,2,æ”¿åºœæ”¯å‡ºå¢—ã§å›½å‚µãƒ•ã‚¡ãƒ³ãƒ‰ +2%">æ”¿åºœæ”¯å‡ºå¢—ã§å›½å‚µãƒ•ã‚¡ãƒ³ãƒ‰ +2%</option>
        <option value="1,-2,è²¡æ”¿ä¸å®‰ã§å›½å‚µãƒ•ã‚¡ãƒ³ãƒ‰ -2%">è²¡æ”¿ä¸å®‰ã§å›½å‚µãƒ•ã‚¡ãƒ³ãƒ‰ -2%</option>
        <option value="2,4,çµŒæ¸ˆæˆé•·ã§æ ªå¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ +4%">çµŒæ¸ˆæˆé•·ã§æ ªå¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ +4%</option>
        <option value="2,-6,ä¸–ç•Œä¸æ³ã§æ ªå¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ -6%">ä¸–ç•Œä¸æ³ã§æ ªå¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ -6%</option>
        <option value="3,12,æ–°æŠ€è¡“ãƒ–ãƒ¼ãƒ ã§ãƒã‚¤ãƒ†ã‚¯æ ª +12%">æ–°æŠ€è¡“ãƒ–ãƒ¼ãƒ ã§ãƒã‚¤ãƒ†ã‚¯æ ª +12%</option>
        <option value="3,-18,ITãƒãƒ–ãƒ«å´©å£Šã§ãƒã‚¤ãƒ†ã‚¯æ ª -18%">ITãƒãƒ–ãƒ«å´©å£Šã§ãƒã‚¤ãƒ†ã‚¯æ ª -18%</option>
        <option value="4,20,ä»®æƒ³é€šè²¨ãŒè©±é¡Œã§ +20%">ä»®æƒ³é€šè²¨ãŒè©±é¡Œã§ +20%</option>
        <option value="4,-30,ä»®æƒ³é€šè²¨ãƒãƒƒã‚­ãƒ³ã‚°ã§ -30%">ä»®æƒ³é€šè²¨ãƒãƒƒã‚­ãƒ³ã‚°ã§ -30%</option>
        <option value="5,50,ãƒ™ãƒ³ãƒãƒ£ãƒ¼ä¼æ¥­ãŒä¸Šå ´æˆåŠŸï¼ +50%">ãƒ™ãƒ³ãƒãƒ£ãƒ¼ä¼æ¥­ãŒä¸Šå ´æˆåŠŸï¼ +50%</option>
        <option value="5,-50,è©æ¬ºç™ºè¦šã§ãƒ™ãƒ³ãƒãƒ£ãƒ¼æŠ•è³‡ -50%">è©æ¬ºç™ºè¦šã§ãƒ™ãƒ³ãƒãƒ£ãƒ¼æŠ•è³‡ -50%</option>
      </select>
      <button id="applyEventBtn" onclick="applySelectedEvent()">ã‚¤ãƒ™ãƒ³ãƒˆåæ˜ </button>
    </div>

    <div class="log">
      <strong>ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°:</strong>
      <ul id="eventLog"></ul>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
  <script>
    const socket = io('http://localhost:3000');
    let roomId = '';
    let round = 1;
    let eventApplied = false;

    function initializeRoom() {
      roomId = document.getElementById("roomId").value;
      if (!roomId) {
        alert("ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }
      socket.emit('join_room', { roomId, role: 'gm' });
      socket.emit('initialize_room', { roomId });
      document.getElementById("connectionStatus").textContent = "æ¥ç¶šæ¸ˆã¿";
      document.getElementById("connectionStatus").className = "status-connected";
      setupShareSection(roomId);
    }

    function setupShareSection(roomId) {
      const shareSection = document.getElementById("shareSection");
      const playerLink = document.getElementById("playerLink");
      const currentUrl = window.location.href;
      const baseUrl = currentUrl.replace(/\/[^\/]*$/, '/');
      const playerUrl = `${baseUrl}player.html?room=${encodeURIComponent(roomId)}`;
      playerLink.value = playerUrl;
      shareSection.style.display = "block";
    }

    function copyLink() {
      const playerLink = document.getElementById("playerLink");
      playerLink.select();
      playerLink.setSelectionRange(0, 99999);
      try {
        document.execCommand('copy');
        alert("ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
      } catch (err) {
        alert("ãƒªãƒ³ã‚¯ã‚’æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼š\n" + playerLink.value);
      }
    }

    function generateQR() {
      const playerLink = document.getElementById("playerLink").value;
      const qrSection = document.getElementById("qrSection");
      const qrDiv = document.getElementById("qrcode");
      qrDiv.innerHTML = "";
      try {
        const qr = qrcode(0, 'M');
        qr.addData(playerLink);
        qr.make();
        qrDiv.innerHTML = qr.createImgTag(4, 8);
        qrSection.style.display = "block";
      } catch (error) {
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(playerLink)}`;
        qrDiv.innerHTML = `<img src="${qrUrl}" alt="QRã‚³ãƒ¼ãƒ‰" style="max-width: 200px;">`;
        qrSection.style.display = "block";
      }
    }

    function applySelectedEvent() {
      if (eventApplied) return;
      eventApplied = true;
      const value = document.getElementById("eventSelect").value;
      if (!value) {
        alert("ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        eventApplied = false;
        return;
      }
      const [index, change, text] = value.split(",");
      socket.emit('apply_event', { roomId, idx: parseInt(index), delta: parseFloat(change), text });
      document.getElementById("eventSelect").value = "";
      setTimeout(() => { eventApplied = false; }, 300);
    }

    function startRound() {
      document.getElementById("gmButton").disabled = true;
      document.getElementById("eventStatus").textContent = `ãƒ©ã‚¦ãƒ³ãƒ‰${round}ã®è¨ˆç®—ã‚’å®Ÿè¡Œä¸­...`;
      socket.emit('start_round', { roomId });
      setTimeout(() => {
        document.getElementById("eventStatus").textContent = `ãƒ©ã‚¦ãƒ³ãƒ‰${round}ã®è¨ˆç®—ãŒå®Œäº†ã—ã¾ã—ãŸã€‚æ–°ã—ã„è³‡ç”£ã§ãƒ™ãƒƒãƒˆå¯èƒ½ã§ã™ã€‚`;
        round++;
        document.getElementById("gmButton").disabled = false;
      }, 500);
    }

    // ãƒ«ãƒ¼ãƒ çŠ¶æ…‹æ›´æ–°
    socket.on('room_state', data => {
      updateTableReturns(data.baseReturns);
      round = data.round;
      updateEventLog(data.events);
      updatePlayerList(data.players);
    });

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆæ›´æ–°
    socket.on('player_list_update', updatePlayerList);

    function updateTableReturns(baseReturns) {
      const returnCells = document.querySelectorAll(".base-return");
      baseReturns.forEach((val, index) => {
        if (returnCells[index]) {
          returnCells[index].textContent = val.toFixed(1);
        }
      });
    }
    function updateEventLog(events) {
      const log = document.getElementById("eventLog");
      log.innerHTML = '';
      events.forEach(e => {
        const li = document.createElement("li");
        const t = new Date(e.time).toLocaleTimeString();
        li.textContent = `[${t}] ${e.text}`;
        log.appendChild(li);
      });
    }
    function updatePlayerList(players) {
      const list = document.getElementById("playerList");
      list.innerHTML = "";
      if (!players || Object.keys(players).length === 0) {
        const li = document.createElement("li");
        li.textContent = "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‚åŠ ã‚’å¾…ã£ã¦ã„ã¾ã™...";
        list.appendChild(li);
        return;
      }
      Object.entries(players).forEach(([playerId, data]) => {
        const li = document.createElement("li");
        const total = (data.investments || []).reduce((sum, v) => sum + v, 0);
        const status = data.ready ? "âœ… ãƒ™ãƒƒãƒˆæ¸ˆã¿" : "â³ ãƒ™ãƒƒãƒˆå¾…ã¡";
        li.textContent = `${playerId}ï¼š${total.toLocaleString()}å†† ${status}`;
        list.appendChild(li);
      });
    }
    // åˆæœŸè¡¨ç¤º
    updateTableReturns([2, 3, 6, 10, 30, 0]);
  </script>
</body>
</html>