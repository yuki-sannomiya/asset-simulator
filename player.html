<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>è³‡ç”£ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ - ãƒã‚¤ï¼†ãƒ­ãƒ¼æŠ•è³‡ã‚²ãƒ¼ãƒ ï¼ˆGMç”¨ï¼‰</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #fff; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    .section { margin-bottom: 30px; }
    .status-connected { color: green; font-weight: bold; }
    .status-disconnected { color: red; font-weight: bold; }
    button { padding: 10px 20px; font-size: 1em; margin-right: 10px; }
    .log { background: #f8f8f8; padding: 10px; border: 1px solid #ccc; max-height: 150px; overflow-y: auto; }
    #shareSection { display: none; background: #eef; padding: 15px; border-radius: 5px; }
    #qrSection { display: none; text-align: center; margin-top: 15px; }
  </style>
</head>
<body>
  <h1>è³‡ç”£ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆãƒã‚¤ï¼†ãƒ­ãƒ¼æŠ•è³‡ã‚²ãƒ¼ãƒ ï¼‰- GMç”¨</h1>

  <div class="section">
    <label>ãƒ«ãƒ¼ãƒ ID: <input type="text" id="roomId" value="testroom" /></label>
    <button id="initBtn">ãƒ«ãƒ¼ãƒ åˆæœŸåŒ–</button>
    <span id="connectionStatus" class="status-disconnected">æœªæ¥ç¶š</span>
  </div>

  <div id="shareSection">
    <h3>ğŸ® ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ‹›å¾…</h3>
    <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”¨ãƒªãƒ³ã‚¯ï¼š
      <input type="text" id="playerLink" readonly style="width:80%;" />
    </label>
    <button id="copyBtn">ã‚³ãƒ”ãƒ¼</button>
    <button id="qrBtn">QRã‚³ãƒ¼ãƒ‰</button>
    <div id="qrSection"><div id="qrcode"></div></div>
  </div>

  <div class="section">
    <h3>ç¾åœ¨ã®åˆ©å›ã‚Šè¨­å®š</h3>
    <table>
      <thead><tr><th>è³‡ç”£ã‚¿ã‚¤ãƒ—</th><th>åˆ©å›ã‚Šï¼ˆ%ï¼‰</th></tr></thead>
      <tbody>
        <tr><td>å®šæœŸé é‡‘</td><td class="base-return">2.0</td></tr>
        <tr><td>å›½å‚µãƒ•ã‚¡ãƒ³ãƒ‰</td><td class="base-return">3.0</td></tr>
        <tr><td>æ ªå¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹</td><td class="base-return">6.0</td></tr>
        <tr><td>ãƒã‚¤ãƒ†ã‚¯æ ª</td><td class="base-return">10.0</td></tr>
        <tr><td>ä»®æƒ³é€šè²¨</td><td class="base-return">30.0</td></tr>
        <tr><td>ãƒ™ãƒ³ãƒãƒ£ãƒ¼æŠ•è³‡</td><td class="base-return">0.0</td></tr>
      </tbody>
    </table>
  </div>

  <div class="section">
    <h3>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‚åŠ çŠ¶æ³</h3>
    <ul id="playerList"><li>å‚åŠ å¾…ã¡â€¦</li></ul>
  </div>

  <div class="section">
    <h2>ã‚²ãƒ¼ãƒ é€²è¡Œæ“ä½œ</h2>
    <button id="gmButton">ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹</button>
    <div id="eventStatus">ã‚¤ãƒ™ãƒ³ãƒˆå¾…ã¡â€¦</div>
  </div>

  <div class="section">
    <h2>ã‚¤ãƒ™ãƒ³ãƒˆåæ˜ </h2>
    <select id="eventSelect">
      <option value="">â–¼é¸æŠâ–¼</option>
      <option value="0,1,é‡‘åˆ©ä¸Šæ˜‡ã§å®šæœŸé é‡‘ +1%">é‡‘åˆ©ä¸Šæ˜‡ã§å®šæœŸé é‡‘ +1%</option>
      <!-- ä»¥ä¸‹åŒæ§˜ã«â€¦ -->
    </select>
    <button id="applyEventBtn">åæ˜ </button>
  </div>

  <div class="log">
    <strong>ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°:</strong>
    <ul id="eventLog"></ul>
  </div>

  <!-- Socket.IO & QR ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
  <script>
    // ã‚µãƒ¼ãƒãƒ¼ã¨åŒã˜ã‚ªãƒªã‚¸ãƒ³ã«æ¥ç¶š
    const ORIGIN = location.protocol + '//' + location.host;
    const socket = io(ORIGIN, { transports: ['websocket','polling'] });

    let roomId = '';
    let round = 1;
    let eventApplied = false;

    // DOMå–å¾—
    const initBtn = document.getElementById('initBtn');
    const statusSpan = document.getElementById('connectionStatus');
    const shareSec = document.getElementById('shareSection');
    const playerLinkInput = document.getElementById('playerLink');
    const copyBtn = document.getElementById('copyBtn');
    const qrBtn = document.getElementById('qrBtn');
    const qrSec = document.getElementById('qrSection');
    const gmBtn = document.getElementById('gmButton');
    const applyEventBtn = document.getElementById('applyEventBtn');
    const eventSelect = document.getElementById('eventSelect');

    initBtn.addEventListener('click', () => {
      roomId = document.getElementById('roomId').value.trim();
      if (!roomId) return alert('ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      socket.emit('join_room', { roomId, role: 'gm' });
      socket.emit('initialize_room', { roomId });
      statusSpan.textContent = 'æ¥ç¶šæ¸ˆã¿'; statusSpan.className='status-connected';
      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªãƒ³ã‚¯ç”Ÿæˆ
      const base = location.href.replace(/\/[^\/]*$/, '/');
      playerLinkInput.value = `${base}player.html?room=${encodeURIComponent(roomId)}`;
      shareSec.style.display = 'block';
    });

    copyBtn.addEventListener('click', () => {
      playerLinkInput.select();
      document.execCommand('copy');
      alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
    });

    qrBtn.addEventListener('click', () => {
      qrSec.style.display = 'block';
      const qr = qrcode(0,'M');
      qr.addData(playerLinkInput.value);
      qr.make();
      document.getElementById('qrcode').innerHTML = qr.createImgTag(4,8);
    });

    gmBtn.addEventListener('click', () => {
      gmBtn.disabled = true;
      socket.emit('start_round', { roomId });
      setTimeout(() => {
        gmBtn.disabled = false;
        round++;
      }, 500);
    });

    applyEventBtn.addEventListener('click', () => {
      if (eventApplied) return;
      const v = eventSelect.value;
      if (!v) return alert('é¸æŠã—ã¦ãã ã•ã„');
      const [idx, delta, text] = v.split(',');
      socket.emit('apply_event', {
        roomId, idx: +idx, delta: +delta, text
      });
      eventApplied = true;
      setTimeout(() => eventApplied=false, 300);
    });

    // ã‚µãƒ¼ãƒãƒ¼â†’GM æ›´æ–°é€šçŸ¥
    socket.on('room_state', data => {
      // åˆ©å›ã‚Šæ›´æ–°
      document.querySelectorAll('.base-return')
        .forEach((td,i)=> td.textContent = data.baseReturns[i].toFixed(1));
      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆ
      const ul = document.getElementById('playerList');
      ul.innerHTML = '';
      for (const [pid, d] of Object.entries(data.players||{})) {
        const li = document.createElement('li');
        const sum = (d.investments||[]).reduce((a,b)=>a+b,0);
        li.textContent = `${pid}: ${sum}å†† ${d.ready? 'âœ…':'â³'}`;
        ul.appendChild(li);
      }
      if (!data.players || !Object.keys(data.players).length) {
        ul.innerHTML = '<li>å‚åŠ å¾…ã¡â€¦</li>';
      }
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°
      const logUl = document.getElementById('eventLog');
      logUl.innerHTML = '';
      data.events.forEach(e => {
        const li = document.createElement('li');
        li.textContent = `[${new Date(e.time).toLocaleTimeString()}] ${e.text}`;
        logUl.appendChild(li);
      });
    });

    socket.on('player_list_update', players=>{
      // ï¼ˆå¿…è¦ãªã‚‰å€‹åˆ¥ã«ã‚‚ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰
    });
  </script>
</body>
</html>
