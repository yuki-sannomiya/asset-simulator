<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”»é¢</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    .base-return { font-weight: bold; }
    .bet-input { width: 80px; }
    #betStatus { font-weight: bold; margin-top: 10px; }
    .bet-confirmed { color: green; }
    .bet-warning { color: red; }
    .player-list { margin-top: 30px; }
    .connection-status { margin: 10px 0; padding: 10px; border-radius: 5px; }
    .connected { background: #e6f3ff; color: #0066cc; }
    .disconnected { background: #ffe6e6; color: #cc0000; }
    .event-notification { 
      background: #fff3cd; 
      border: 1px solid #ffeaa7; 
      padding: 10px; 
      margin: 10px 0; 
      border-radius: 5px;
      display: none;
    }
    .funds-display { 
      background: #f8f9fa; 
      padding: 15px; 
      margin: 15px 0; 
      border-radius: 5px; 
      text-align: center; 
      font-size: 1.2em;
    }
    .return-changed { 
      background: #ffffcc !important; 
      animation: highlight 2s ease-out;
    }
    @keyframes highlight {
      0% { background: #ffff99 !important; }
      100% { background: #ffffcc !important; }
    }
  </style>
</head>
<body>
  <h2>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”»é¢ - è³‡ç”£ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h2>

  <div class="connection-status disconnected" id="connectionStatus">
    æœªæ¥ç¶š - ãƒ«ãƒ¼ãƒ ã«å‚åŠ ã—ã¦ãã ã•ã„
  </div>

  <div class="event-notification" id="eventNotification">
    <strong>ğŸ“ˆ ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿï¼</strong>
    <span id="eventText"></span>
  </div>

  <label>ãƒ«ãƒ¼ãƒ IDï¼š<input type="text" id="roomIdInput" value="testroom"></label>
  <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDï¼š<input type="text" id="playerIdInput" value="player1"></label>
  <button onclick="joinRoom()">å‚åŠ </button>

  <div id="gameArea" style="display:none;">
    <div class="funds-display">
      æ‰€æŒé‡‘ï¼š<span id="currentFunds">100,000</span>å††
      <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
        <span id="fundsChange"></span>
      </div>
    </div>

    <table>
      <thead>
        <tr><th>è³‡ç”£ã‚¿ã‚¤ãƒ—</th><th>åˆ©å›ã‚Šï¼ˆ%ï¼‰</th><th>ãƒ™ãƒƒãƒˆé¡</th></tr>
      </thead>
      <tbody id="returnsTable">
        <tr><td>å®šæœŸé é‡‘</td><td class="base-return">2.0</td><td><input class="bet-input" type="number" min="0" oninput="updateTotal()"></td></tr>
        <tr><td>å›½å‚µãƒ•ã‚¡ãƒ³ãƒ‰</td><td class="base-return">3.0</td><td><input class="bet-input" type="number" min="0" oninput="updateTotal()"></td></tr>
        <tr><td>æ ªå¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹</td><td class="base-return">6.0</td><td><input class="bet-input" type="number" min="0" oninput="updateTotal()"></td></tr>
        <tr><td>ãƒã‚¤ãƒ†ã‚¯æ ª</td><td class="base-return">10.0</td><td><input class="bet-input" type="number" min="0" oninput="updateTotal()"></td></tr>
        <tr><td>ä»®æƒ³é€šè²¨</td><td class="base-return">30.0</td><td><input class="bet-input" type="number" min="0" oninput="updateTotal()"></td></tr>
        <tr><td>ãƒ™ãƒ³ãƒãƒ£ãƒ¼æŠ•è³‡</td><td class="base-return">0.0</td><td><input class="bet-input" type="number" min="0" oninput="updateTotal()"></td></tr>
      </tbody>
    </table>
    
    <div style="text-align: center; margin: 15px 0;">
      <strong>åˆè¨ˆãƒ™ãƒƒãƒˆé¡ï¼š<span id="totalBet">0</span>å††</strong>
    </div>
    
    <button onclick="confirmBet()">ãƒ™ãƒƒãƒˆç¢ºå®š</button>
    <p id="betStatus"></p>

    <div class="player-list">
      <h3>ãƒ«ãƒ¼ãƒ å†…ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§</h3>
      <ul id="playerList"></ul>
    </div>
  </div>

  <script>
    let currentFunds = 100000;
    let currentReturns = [2, 3, 6, 10, 30, 0];
    let roomId = "";
    let playerId = "";
    let isConnected = false;

    function joinRoom() {
      roomId = document.getElementById("roomIdInput").value;
      playerId = document.getElementById("playerIdInput").value;
      
      if (!roomId || !playerId) {
        alert("ãƒ«ãƒ¼ãƒ IDã¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      // æ¥ç¶šçŠ¶æ…‹ã‚’æ›´æ–°
      isConnected = true;
      const statusEl = document.getElementById("connectionStatus");
      statusEl.textContent = `ãƒ«ãƒ¼ãƒ  "${roomId}" ã« "${playerId}" ã¨ã—ã¦å‚åŠ ä¸­`;
      statusEl.className = "connection-status connected";

      // ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
      document.getElementById("gameArea").style.display = "block";

      // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      loadGameData();

      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’ä¿å­˜
      savePlayerData();

      // å®šæœŸçš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
      startDataMonitoring();
    }

    function loadGameData() {
      const savedData = localStorage.getItem(`room_${roomId}`);
      if (savedData) {
        const gameData = JSON.parse(savedData);
        if (gameData.baseReturns) {
          updateReturns(gameData.baseReturns);
        }
      }
    }

    function savePlayerData() {
      const playersData = localStorage.getItem(`room_${roomId}_players`);
      let players = playersData ? JSON.parse(playersData) : {};
      
      players[playerId] = {
        investments: [0, 0, 0, 0, 0, 0],
        ready: false,
        funds: currentFunds,
        lastUpdate: Date.now()
      };
      
      localStorage.setItem(`room_${roomId}_players`, JSON.stringify(players));
    }

    function startDataMonitoring() {
      setInterval(() => {
        if (!isConnected) return;

        // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ã‚’ç›£è¦–
        const savedData = localStorage.getItem(`room_${roomId}`);
        if (savedData) {
          const gameData = JSON.parse(savedData);
          if (gameData.baseReturns) {
            updateReturns(gameData.baseReturns);
          }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ã‚’ç›£è¦–ï¼ˆè³‡ç”£æ›´æ–°ãªã©ï¼‰
        checkPlayerDataUpdate();

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        updatePlayerList();
      }, 1000);
    }

    function checkPlayerDataUpdate() {
      const playersData = localStorage.getItem(`room_${roomId}_players`);
      if (!playersData) return;

      const players = JSON.parse(playersData);
      const myData = players[playerId];
      
      if (myData && myData.funds !== currentFunds) {
        // è³‡ç”£ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆ
        const oldFunds = currentFunds;
        currentFunds = myData.funds;
        
        // è¡¨ç¤ºã‚’æ›´æ–°
        document.getElementById("currentFunds").textContent = currentFunds.toLocaleString();
        
        // å¤‰åŒ–é‡ã‚’è¡¨ç¤º
        const changeAmount = currentFunds - oldFunds;
        const changeEl = document.getElementById("fundsChange");
        if (changeAmount > 0) {
          changeEl.textContent = `+${changeAmount.toLocaleString()}å††`;
          changeEl.style.color = "#28a745";
        } else if (changeAmount < 0) {
          changeEl.textContent = `${changeAmount.toLocaleString()}å††`;
          changeEl.style.color = "#dc3545";
        } else {
          changeEl.textContent = "";
        }
        
        // è³‡ç”£å¤‰æ›´ã®é€šçŸ¥
        if (currentFunds > oldFunds) {
          showEventNotification(`ğŸ’° è³‡ç”£ãŒå¢—åŠ ã—ã¾ã—ãŸï¼ ${oldFunds.toLocaleString()}å†† â†’ ${currentFunds.toLocaleString()}å††`);
        } else if (currentFunds < oldFunds) {
          showEventNotification(`ğŸ“‰ è³‡ç”£ãŒæ¸›å°‘ã—ã¾ã—ãŸã€‚ ${oldFunds.toLocaleString()}å†† â†’ ${currentFunds.toLocaleString()}å††`);
        }
        
        // ãƒ™ãƒƒãƒˆçŠ¶æ³ã‚’ãƒªã‚»ãƒƒãƒˆ
        if (!myData.ready) {
          resetBetInputs();
          const status = document.getElementById("betStatus");
          status.textContent = "æ–°ã—ã„è³‡ç”£ã§ãƒ™ãƒƒãƒˆã§ãã¾ã™";
          status.className = "";
        }
      }
    }

    function resetBetInputs() {
      const inputs = document.querySelectorAll(".bet-input");
      inputs.forEach(input => {
        input.value = "";
      });
      updateTotal();
    }

    function updateReturns(newReturns) {
      const cells = document.querySelectorAll(".base-return");
      let hasChanged = false;

      newReturns.forEach((val, i) => {
        if (cells[i] && Math.abs(currentReturns[i] - val) > 0.01) {
          // å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã€ãƒã‚¤ãƒ©ã‚¤ãƒˆ
          cells[i].parentElement.classList.add('return-changed');
          setTimeout(() => {
            cells[i].parentElement.classList.remove('return-changed');
          }, 2000);
          hasChanged = true;
        }
        if (cells[i]) {
          cells[i].textContent = val.toFixed(1);
        }
      });

      // ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥ã‚’è¡¨ç¤º
      if (hasChanged) {
        showEventNotification("åˆ©å›ã‚ŠãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸï¼");
      }

      currentReturns = [...newReturns];
    }

    function showEventNotification(message) {
      const notification = document.getElementById("eventNotification");
      const textEl = document.getElementById("eventText");
      textEl.textContent = message;
      notification.style.display = "block";
      
      setTimeout(() => {
        notification.style.display = "none";
      }, 3000);
    }

    function updatePlayerList() {
      const playersData = localStorage.getItem(`room_${roomId}_players`);
      if (!playersData) return;

      const players = JSON.parse(playersData);
      const list = document.getElementById("playerList");
      list.innerHTML = "";

      Object.entries(players).forEach(([id, data]) => {
        const li = document.createElement("li");
        const total = (data.investments || []).reduce((sum, v) => sum + v, 0);
        const status = data.ready ? "âœ… ãƒ™ãƒƒãƒˆæ¸ˆã¿" : "â³ ãƒ™ãƒƒãƒˆå¾…ã¡";
        li.textContent = `${id}ï¼š${total.toLocaleString()}å†† ${status}`;
        list.appendChild(li);
      });
    }

    function updateTotal() {
      const inputs = document.querySelectorAll(".bet-input");
      let total = 0;
      inputs.forEach(input => {
        total += parseInt(input.value) || 0;
      });
      document.getElementById("totalBet").textContent = total.toLocaleString();
    }

    function confirmBet() {
      const inputs = document.querySelectorAll(".bet-input");
      let values = Array.from(inputs).map(input => parseInt(input.value) || 0);
      let total = values.reduce((sum, v) => sum + v, 0);

      if (total !== currentFunds) {
        const status = document.getElementById("betStatus");
        status.textContent = `âŒ åˆè¨ˆãƒ™ãƒƒãƒˆé¡ãŒæ‰€æŒé‡‘ï¼ˆ${currentFunds.toLocaleString()}å††ï¼‰ã¨ä¸€è‡´ã—ã¦ã„ã¾ã›ã‚“ã€‚`;
        status.className = "bet-warning";
        return;
      }

      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
      const playersData = localStorage.getItem(`room_${roomId}_players`);
      let players = playersData ? JSON.parse(playersData) : {};
      
      players[playerId] = {
        investments: values,
        ready: true,
        funds: currentFunds,
        lastUpdate: Date.now()
      };
      
      localStorage.setItem(`room_${roomId}_players`, JSON.stringify(players));

      const status = document.getElementById("betStatus");
      status.textContent = "âœ… ãƒ™ãƒƒãƒˆæ¸ˆã¿ã§ã™";
      status.className = "bet-confirmed";
    }

    // åˆæœŸè¡¨ç¤º
    document.getElementById("currentFunds").textContent = currentFunds.toLocaleString();
  </script>
</body>
</html>